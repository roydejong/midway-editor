/*! midway-editor 2017-02-03 */
var MidwayToolbar={$toolbar:null,$buttonsContainer:null,$linkInputContainer:null,$linkInputField:null,$linkInputCloseBtn:null,isVisible:!1,existsInDom:!1,availableButtons:{},selectionContext:null,registerButton:function(a){a instanceof MidwayToolbarButton?this.availableButtons[a.id]=a:console.warn("Midway Editor: You must pass an instance of MidwayToolbarButton to registerButton()")},prepareOnPage:function(){this.existsInDom||(this.existsInDom=!0,this.isVisible=!1,this.$toolbar=$('<div class="midway-toolbar virgin-toolbar"><div class="inner"><div class="buttons"></div><div class="link-input"><input class="link-field" placeholder="Paste or type a link..."><a class="link-cancel-btn"><i class="fa fa-times"></i></a></div><div class="arrow-container"><div class="arrow"></div></div></div></div>'),this.$toolbar.appendTo($("body")),this.$buttonsContainer=this.$toolbar.find(".buttons"),this.$linkInputContainer=this.$toolbar.find(".link-input"),this.$linkInputField=this.$linkInputContainer.find("input"),this.$linkInputCloseBtn=this.$linkInputContainer.find(".link-cancel-btn"),this.$toolbar.click(function(a){return a.preventDefault(),!1}))},setToolbarContext:function(a,b){if("Range"!=b.type)return void console.error("Midway Toolbar: setToolbarContext() failed, invalid text selection data:"+b.type);this.selectionContext=new MidwayStoredSelection(b),this.$buttonsContainer.html("");for(var c=a.options.buttons,d=c.split(" "),e=0;e<d.length;e++){var f=d[e].trim(),g=this.availableButtons[f];if("|"!=f)if(g){var h=$("<a />").addClass("button").attr("title",g.label).addClass(g.style).append('<i class="fa fa-'+g.icon+'"></i>');h.click(function(c){c.preventDefault();var d=this.apply(a,b);return d||MidwayToolbar.hide(),!1}.bind(g));var i=g.queryState(a,b);"false"!=i&&i&&h.addClass("active"),this.$buttonsContainer.append(h)}else console.warn("Midway Editor: Unsupported button type",f);else $("<div />").addClass("separator").appendTo(this.$buttonsContainer)}var j=this;this.$linkInputField.unbind("keypress.midway"),this.$linkInputField.on("keypress.midway",function(b){if(13==b.keyCode){b.preventDefault();var c=j.$linkInputField.val();return c.indexOf("http://")==-1&&c.indexOf("https://")==-1&&(c="http://"+c),j.closeLinkInput(),j.hide(),a.restoreSelection(j.selectionContext),document.execCommand("createLink",!1,c),!1}}),this.$linkInputCloseBtn.unbind("click.midway"),this.$linkInputCloseBtn.on("click.midway",function(b){return b.preventDefault(),j.closeLinkInput(),a.restoreSelection(j.selectionContext),!1})},show:function(a,b){this.existsInDom||MidwayToolbar.prepareOnPage();var c=b.getRangeAt(0),d=c.getBoundingClientRect(),e=this.$toolbar.outerWidth(),f=this.$toolbar.outerHeight(),g=this.$toolbar.find(".arrow").outerHeight(),h=d.left+(d.width/2-e/2),i=d.top-f-g/2;h<5&&(h=5),i<5&&(i=5),this.setToolbarContext(a,b),this.$toolbar.css("top",i+"px").css("left",h+"px").addClass("active"),this.isVisible=!0,this.$buttonsContainer.css("visibility","visible"),this.$linkInputContainer.hide()},showLinkInput:function(){this.isVisible&&(this.$buttonsContainer.css("visibility","hidden"),this.$linkInputContainer.show(),this.$linkInputContainer.find("input").focus(),this.$linkInputField.val(""))},closeLinkInput:function(){this.isVisible&&(this.$buttonsContainer.css("visibility","visible"),this.$linkInputContainer.hide())},hide:function(){this.isVisible&&(this.$toolbar.removeClass("active").removeClass("virgin-toolbar"),this.isVisible=!0)}},MidwayToolbarButton=function(a,b){this.id=a,this.label="Button",this.icon=this.id,this.style="",b&&(this.label=b),this.apply=function(a,b){return!1},this.queryState=function(a,b){return!1}},btnBlockquote=new MidwayToolbarButton("blockquote","Quote");btnBlockquote.icon="quote-left",btnBlockquote.apply=function(){return btnBlockquote.queryState()?document.execCommand("formatBlock",!1,"<p>"):document.execCommand("formatBlock",!1,"<blockquote>")},btnBlockquote.queryState=function(){var a=document.queryCommandValue("formatBlock");return a&&"blockquote"==a.toLowerCase()},MidwayToolbar.registerButton(btnBlockquote);var btnMidwayBold=new MidwayToolbarButton("bold","Bold");btnMidwayBold.apply=function(){return document.execCommand("bold")},btnMidwayBold.queryState=function(){return document.queryCommandState("bold")},MidwayToolbar.registerButton(btnMidwayBold);var btnMidwayHeadingTwo=new MidwayToolbarButton("h2","Big heading");btnMidwayHeadingTwo.icon="header",btnMidwayHeadingTwo.apply=function(){return btnMidwayHeadingTwo.queryState()?document.execCommand("formatBlock",!1,"<p>"):document.execCommand("formatBlock",!1,"<h2>")},btnMidwayHeadingTwo.queryState=function(){var a=document.queryCommandValue("formatBlock");return a&&"h2"==a.toLowerCase()},MidwayToolbar.registerButton(btnMidwayHeadingTwo);var btnMidwayHeadingThree=new MidwayToolbarButton("h3","Small heading");btnMidwayHeadingThree.icon="header",btnMidwayHeadingThree.style="smaller",btnMidwayHeadingThree.apply=function(){return btnMidwayHeadingThree.queryState()?document.execCommand("formatBlock",!1,"<p>"):document.execCommand("formatBlock",!1,"<h3>")},btnMidwayHeadingThree.queryState=function(){var a=document.queryCommandValue("formatBlock");return a&&"h3"==a.toLowerCase()},MidwayToolbar.registerButton(btnMidwayHeadingThree);var btnMidwayItalic=new MidwayToolbarButton("italic","Italic");btnMidwayItalic.apply=function(){return document.execCommand("italic")},btnMidwayItalic.queryState=function(){return document.queryCommandState("italic")},MidwayToolbar.registerButton(btnMidwayItalic);var btnMidwayLink=new MidwayToolbarButton("link","Link");btnMidwayLink.apply=function(a){return btnMidwayLink.queryState(a)?document.execCommand("unlink",!1,!1):(MidwayToolbar.showLinkInput(a),!0)},btnMidwayLink.queryState=function(a){return a.caretGetNode().is("a")||a.caretGetNode().children().has("a").length>0},MidwayToolbar.registerButton(btnMidwayLink);var MidwayHtmlCleanup={cleanNode:function(a,b){var c=b.isNode(["h1","h2","h3"]),d=(b.html(),""==b.text().trim()&&!b.hasClass("ghost-node")),e="Title";if(d&&c&&(b.html(""),b.is("h1")&&b.text(e).data("placeholder",e).removeClass("midway-zw-hack").addClass("ghost-node")),b.hasClass("ghost-node")){var f=b.text().length-b.data("placeholder").length;f>0&&(b.text(b.text().substring(0,f)),b.removeClass("ghost-node"),a.$lastUserNode==b&&a.caretSetPos(b,b.text().length))}b.find("span").each(function(){var a=$(this);a.replaceWith(a.text())}),b.find("*").attr("style","");var g=b.parent().is(a.$rootDiv);if(g&&!b.isNode(["h1","h2","h3","blockquote","p"])){var h=$("<p />").html(b.html());b.replaceWith(h)}}},MidwayStoredSelection=function(a){if(this.ranges=[],a.type=a.rangeCount>0)for(var b=0;b<a.rangeCount;b++)this.ranges.push(a.getRangeAt(b));this.rangeCount=this.ranges.length,this.getRangeAt=function(a){return this.ranges[a]}},MidwayEditor=function(a,b){this.options=b,this.$rootDiv=a,this.$titleNode=null,this.$nextUserNode=null,this.$lastUserNode=null,this.begin=function(){var a=this;this.checkPlaceholders(),this.$rootDiv.attr("contenteditable",!0),$("html").on("click",function(){a.checkSelection()}),MidwayTooltip.register(this.$rootDiv,"a"),this.$rootDiv.on("mousedown.midway",function(b){var c=$(b.target),d=!1;return c.hasClass("ghost-node")&&(d=!0),d&&b.preventDefault(),a.$nextUserNode=c,a.checkCaret(),!d}),this.$rootDiv.on("mouseup.midway",function(b){a.checkCaret()}),this.$rootDiv.on("click.midway",function(){a.checkCaret()}),this.$rootDiv.on("keydown.midway",function(b){if(a.$nextUserNode=null,13==b.keyCode){if(a.$lastUserNode){if(a.$lastUserNode.isNode(["h1","h2","h3","blockquote"])){b.preventDefault();var c=a.$lastUserNode.next();return 0==c.length&&(c=$("<p />"),c.append("&nbsp;"),c.appendTo(a.$rootDiv)),a.caretSetPos(c,0),!1}if(a.$lastUserNode.isNode("p")&&a.$lastUserNode.hasClass("ghost-node"))return b.preventDefault(),!1}}else if((8==b.keyCode||46==b.keyCode)&&a.$lastUserNode&&a.$lastUserNode.hasClass("ghost-node")){b.preventDefault();var d=a.$lastUserNode.prev();return d.length>0&&a.caretSetPos(d,d.text().length),!1}a.checkCaret()}),this.$rootDiv.on("input.midway",function(b){a.$nextUserNode=null,a.contentChanging(),a.checkCaret()}),this.$rootDiv.on("keyup.midway",function(){a.$nextUserNode=null,a.contentChanging(),a.checkCaret()})},this.contentChanging=function(){this.$lastUserNode&&this.$lastUserNode.length>0&&MidwayHtmlCleanup.cleanNode(this,this.$lastUserNode)},this.checkCaret=function(){var a=this.$nextUserNode?this.$nextUserNode:this.caretGetNode();this.checkPlaceholders(),a.hasClass("ghost-node")&&this.caretSetPos(a,0),window.setTimeout(function(){this.checkSelection(a)}.bind(this),50),this.$lastUserNode=a},this.checkSelection=function(a){var b=window.getSelection();return"Range"!=b.type?void MidwayToolbar.hide():void MidwayToolbar.show(this,b)},this.checkPlaceholders=function(){var a=this.$rootDiv.children().first();a&&a.isNode("h1")||(this.$titleNode=$("<h1 />").prependTo(this.$rootDiv),a=this.$titleNode),MidwayHtmlCleanup.cleanNode(this,a);var b=this.$rootDiv.find("p").not(":empty");if(0==b.length){this.$rootDiv.find("p").remove();var c="Tell your story...";$("<p />").text(c).data("placeholder",c).addClass("ghost-node").appendTo(this.$rootDiv)}},this.restoreSelection=function(a){var b=window.getSelection();b.removeAllRanges();for(var c=0;c<a.rangeCount;c++)b.addRange(a.getRangeAt(c))},this.caretGetPos=function(){var a,b=this.$rootDiv[0],c=0,d=b.ownerDocument||b.document,e=d.defaultView||d.parentWindow;if("undefined"!=typeof e.getSelection){if(a=e.getSelection(),a.rangeCount>0){var f=e.getSelection().getRangeAt(0),g=f.cloneRange();g.selectNodeContents(b),g.setEnd(f.endContainer,f.endOffset),c=g.toString().length}}else if((a=d.selection)&&"Control"!=a.type){var h=a.createRange(),i=d.body.createTextRange();i.moveToElementText(b),i.setEndPoint("EndToEnd",h),c=i.text.length}return c},this.caretGetNode=function(){var a=document.getSelection().anchorNode;return null==a?$(null):$(3==a.nodeType?a.parentNode:a)},this.caretSetPos=function(a,b){if(!a||0==a.length)return console.warn("Midway Editor: caretSetPos() failed, invalid target node"),!1;var c=window.getSelection();if(0==b){var d=document.createRange();d.setStart(a[0],0),d.collapse(!0),c.removeAllRanges(),c.addRange(d)}else c.collapse(a[0],b);return!0},this.begin()},MidwayOptions={buttons:"bold italic link | h2 h3 blockquote"},Midway={edit:function(a,b){var c=$(a);if(b=$.extend(MidwayOptions,b),0==c.length)return console.error("Midway Editor: Could not find editable target:",a),null;var d=[];return c.each(function(){var a=$(this),c=new MidwayEditor(a,b);d.push(c),window.midwayInstance=c}),1==d.length?d[0]:(console.warn("Midway Editor: Found multiple targets with selector, making each editable:",a),d)}},MidwayTooltip={register:function(a,b){a.off("mouseenter.midway"),a.on("mouseenter.midway",b,function(){MidwayTooltip.showTooltip($(this))}),a.off("mouseleave.midway"),a.on("mouseleave.midway",b,function(a){var b=$(a.toElement),c=$(a.relatedTarget);return b.closest(".midway-tooltip").length||c.closest(".midway-tooltip").length?(a.preventDefault(),!1):void MidwayTooltip.killTooltip($(this))})},getTooltipText:function(a){var b=a.attr("title");if(b)return b;var c=a.attr("alt");if(c)return c;var d=a.attr("href");return d?d:null},showTooltip:function(a){this.killAllTooltips();var b=this.getTooltipText(a);if(!b)return!1;var c=$("<div />").addClass("midway-tooltip"),d=$("<div />").addClass("inner").appendTo(c);if(a.attr("href")){$("<a />").text(b).attr("href",a.attr("href")).attr("target","_blank").appendTo(d)}else d.text(b);c.append('<div class="arrow-container"><div class="arrow"></div></div>'),a.data("tooltip",c),$("body").append(c),c.mouseenter(function(a){return a.preventDefault(),!1}),c.mouseleave(function(a){return a.preventDefault(),MidwayTooltip.killAllTooltips(),!1});var e=c.outerWidth(),f=a[0].getBoundingClientRect(),g=f.left+(f.width/2-e/2),h=f.bottom;return c.css("top",h+"px").css("left",g+"px"),!0},killTooltip:function(a){var b=a.data("tooltip");b&&$(b).remove()},killAllTooltips:function(){$(".midway-tooltip").remove()}};jQuery.fn.extend({isNode:function(a){if(!this||0==this.length)return!1;"object"!=typeof a&&(a=[a]);for(var b=0;b<a.length;b++){var c=a[b];if(c=c.toUpperCase(),this.prop("nodeName").toUpperCase()===c)return!0}return!1}});