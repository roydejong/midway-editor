/*! midway-editor 2017-01-31 */
var MidwayToolbar={$toolbar:null,$buttonsContainer:null,$linkInputContainer:null,$linkInputField:null,$linkInputCloseBtn:null,isVisible:!1,existsInDom:!1,availableButtons:{},selectionContext:null,registerButton:function(a){a instanceof MidwayToolbarButton?this.availableButtons[a.id]=a:console.warn("Midway Editor: You must pass an instance of MidwayToolbarButton to registerButton()")},prepareOnPage:function(){this.existsInDom||(this.existsInDom=!0,this.isVisible=!1,this.$toolbar=$('<div class="midway-toolbar virgin-toolbar"><div class="toolbar-inner"><div class="buttons"></div><div class="link-input"><input class="link-field" placeholder="Paste or type a link..."><a class="link-cancel-btn"><i class="fa fa-times"></i></a></div><div class="arrow-container"><div class="arrow"></div></div></div></div>'),this.$toolbar.appendTo($("body")),this.$buttonsContainer=this.$toolbar.find(".buttons"),this.$linkInputContainer=this.$toolbar.find(".link-input"),this.$linkInputField=this.$linkInputContainer.find("input"),this.$linkInputCloseBtn=this.$linkInputContainer.find(".link-cancel-btn"),this.$toolbar.click(function(a){return a.preventDefault(),!1}))},setToolbarContext:function(a,b){if("Range"!=b.type)return void console.error("Midway Toolbar: setToolbarContext() failed, invalid text selection data:"+b.type);this.selectionContext=new MidwayStoredSelection(b),console.info("Midway Toolbar: Context has just changed to:",this.selectionContext),this.$buttonsContainer.html("");for(var c=a.options.buttons,d=c.split(" "),e=0;e<d.length;e++){var f=d[e].trim(),g=this.availableButtons[f];if("|"!=f)if(g){var h=$("<a />").addClass("button").attr("title",g.label).addClass(g.style).append('<i class="fa fa-'+g.icon+'"></i>');h.click(function(c){return c.preventDefault(),this.apply(a,b),!1}.bind(g));var i=g.queryState(a,b);"false"!=i&&i&&h.addClass("active"),this.$buttonsContainer.append(h)}else console.warn("Midway Editor: Unsupported button type",f);else $("<div />").addClass("separator").appendTo(this.$buttonsContainer)}var j=this;this.$linkInputField.unbind("keypress.midway"),this.$linkInputField.on("keypress.midway",function(b){if(13==b.keyCode){b.preventDefault();var c=j.$linkInputField.val();return c.indexOf("http://")==-1&&c.indexOf("https://")==-1&&(c="http://"+c),j.closeLinkInput(),j.hide(),a.restoreSelection(j.selectionContext),document.execCommand("createLink",!1,c),!1}}),this.$linkInputCloseBtn.unbind("click.midway"),this.$linkInputCloseBtn.on("click.midway",function(b){return b.preventDefault(),j.closeLinkInput(),a.restoreSelection(j.selectionContext),!1})},show:function(a,b){this.existsInDom||MidwayToolbar.prepareOnPage();var c=b.getRangeAt(0),d=c.getBoundingClientRect(),e=this.$toolbar.outerWidth(),f=this.$toolbar.outerHeight(),g=this.$toolbar.find(".arrow").outerHeight(),h=d.left+(d.width/2-e/2),i=d.top-f-g/2;h<5&&(h=5),i<5&&(i=5),this.setToolbarContext(a,b),this.$toolbar.css("top",i+"px").css("left",h+"px").addClass("active"),this.isVisible=!0,this.$buttonsContainer.css("visibility","visible"),this.$linkInputContainer.hide()},showLinkInput:function(){this.isVisible&&(this.$buttonsContainer.css("visibility","hidden"),this.$linkInputContainer.show(),this.$linkInputContainer.find("input").focus(),this.$linkInputField.val(""))},closeLinkInput:function(){this.isVisible&&(this.$buttonsContainer.css("visibility","visible"),this.$linkInputContainer.hide())},hide:function(){console.error("toolbar hide called"),this.isVisible&&(this.$toolbar.removeClass("active").removeClass("virgin-toolbar"),this.isVisible=!0)}},MidwayToolbarButton=function(a,b,c,d){this.id=a,this.label="Button",this.icon=this.id,this.style="",b&&(this.label=b),this.apply=function(a,b){return!1},this.queryState=function(a,b){return!1},c&&(this.apply=c),d&&(this.queryState=d)},btnBlockquote=new MidwayToolbarButton("blockquote");btnBlockquote.icon="quote-left",btnBlockquote.apply=function(){return btnBlockquote.queryState()?document.execCommand("formatBlock",!1,"<p>"):document.execCommand("formatBlock",!1,"<blockquote>")},btnBlockquote.queryState=function(){var a=document.queryCommandValue("formatBlock");return a&&"blockquote"==a.toLowerCase()},MidwayToolbar.registerButton(btnBlockquote);var btnMidwayBold=new MidwayToolbarButton("bold");btnMidwayBold.apply=function(){return document.execCommand("bold")},btnMidwayBold.queryState=function(){return document.queryCommandState("bold")},MidwayToolbar.registerButton(btnMidwayBold);var btnMidwayHeadingTwo=new MidwayToolbarButton("h2");btnMidwayHeadingTwo.icon="header",btnMidwayHeadingTwo.apply=function(){return btnMidwayHeadingTwo.queryState()?document.execCommand("formatBlock",!1,"<p>"):document.execCommand("formatBlock",!1,"<h2>")},btnMidwayHeadingTwo.queryState=function(){var a=document.queryCommandValue("formatBlock");return a&&"h2"==a.toLowerCase()},MidwayToolbar.registerButton(btnMidwayHeadingTwo);var btnMidwayHeadingThree=new MidwayToolbarButton("h3");btnMidwayHeadingThree.icon="header",btnMidwayHeadingThree.style="smaller",btnMidwayHeadingThree.apply=function(){return btnMidwayHeadingThree.queryState()?document.execCommand("formatBlock",!1,"<p>"):document.execCommand("formatBlock",!1,"<h3>")},btnMidwayHeadingThree.queryState=function(){var a=document.queryCommandValue("formatBlock");return a&&"h3"==a.toLowerCase()},MidwayToolbar.registerButton(btnMidwayHeadingThree);var btnMidwayItalic=new MidwayToolbarButton("italic");btnMidwayItalic.apply=function(){return document.execCommand("italic")},btnMidwayItalic.queryState=function(){return document.queryCommandState("italic")},MidwayToolbar.registerButton(btnMidwayItalic);var btnMidwayLink=new MidwayToolbarButton("link");btnMidwayLink.apply=function(a){btnMidwayLink.queryState(a)?document.execCommand("unlink",!1,!1):MidwayToolbar.showLinkInput(a)},btnMidwayLink.queryState=function(a){return a.caretGetNode().is("a")||a.caretGetNode().children().has("a").length>0},MidwayToolbar.registerButton(btnMidwayLink);var MidwayStoredSelection=function(a){if(this.ranges=[],a.type=a.rangeCount>0)for(var b=0;b<a.rangeCount;b++)this.ranges.push(a.getRangeAt(b));this.rangeCount=this.ranges.length,this.getRangeAt=function(a){return this.ranges[a]}},MidwayEditor=function(a,b){this.options=b,this.$rootDiv=a,this.$titleNode=null,this.$nextUserNode=null,this.$lastUserNode=null,this.begin=function(){var a=this;this.checkPlaceholders(),this.$rootDiv.attr("contenteditable",!0),$("html").on("click",function(){a.checkSelection()}),this.$rootDiv.on("mousedown.midway",function(b){var c=$(b.target),d=!1;return c.hasClass("ghost-node")&&(d=!0),d&&b.preventDefault(),a.$nextUserNode=c,a.checkCaret(),!d}),this.$rootDiv.on("mouseup.midway",function(b){a.checkCaret()}),this.$rootDiv.on("click.midway",function(){a.checkCaret()}),this.$rootDiv.on("keydown.midway",function(b){if(a.$nextUserNode=null,13==b.keyCode){if(a.$lastUserNode){if(a.$lastUserNode.hasClass("post-heading")){b.preventDefault();var c=a.$lastUserNode.parent().find("p").first();return a.caretSetPos(c,0),!1}if(a.$lastUserNode.hasClass("post-paragraph")&&a.$lastUserNode.hasClass("ghost-node"))return b.preventDefault(),!1}}else{if((8==b.keyCode||46==b.keyCode)&&a.$lastUserNode&&a.$lastUserNode.hasClass("ghost-node"))return b.preventDefault(),!1;a.keyCodeIsInput(b.keyCode)&&a.beforeInput()}a.checkCaret()}),this.$rootDiv.on("input.midway",function(){a.$nextUserNode=null,a.contentChanging(),a.checkCaret()}),this.$rootDiv.on("keyup.midway",function(){a.$nextUserNode=null,a.checkCaret()})},this.keyCodeIsInput=function(a){return a>=48&&a<=90||a>=186},this.contentChanging=function(){if(this.$lastUserNode){var a=this.$lastUserNode,b=(a[0],a.html());(noZwHtml=b.replace(/\u200B/g,""))!=b&&(a.html(noZwHtml),this.caretSetPos(a,a.text().length)),0==a.text().trim().length&&a.hasClass("post-heading")&&a.text("Title").addClass("post-heading").addClass("ghost-node").removeClass("was-a-ghost")}},this.beforeInput=function(){var a=this.caretGetNode();a.hasClass("ghost-node")&&(a.html("&#8203;").removeClass("ghost-node").addClass("was-a-ghost"),this.caretSetPos(a,0))},this.checkCaret=function(){var a=this.$nextUserNode?this.$nextUserNode:this.caretGetNode();a.hasClass("ghost-node")&&this.caretSetPos(a,0),this.checkPlaceholders(),window.setTimeout(function(){this.checkSelection(a)}.bind(this),50),this.$lastUserNode=a},this.checkSelection=function(a){var b=window.getSelection();return"Range"!=b.type?void MidwayToolbar.hide():void MidwayToolbar.show(this,b)},this.checkPlaceholders=function(){var a=this.$rootDiv.children().first(),b=function(a){a.text("Title").addClass("post-heading").addClass("ghost-node").removeClass("was-a-ghost")};a&&"H1"==a.prop("nodeName")?this.$titleNode=a:(this.$titleNode=$("<h1 />").prependTo(this.$rootDiv),b(this.$titleNode));var c=(this.$rootDiv.find("p"),this.$rootDiv.find("p").not(":empty"));0==c.length&&(this.$rootDiv.find("p").remove(),$("<p />").text("Tell your story...").addClass("post-paragraph").addClass("ghost-node").appendTo(this.$rootDiv))},this.restoreSelection=function(a){console.log("trying to restore a selection",a);var b=window.getSelection();b.removeAllRanges();for(var c=0;c<a.rangeCount;c++)b.addRange(a.getRangeAt(c))},this.caretGetPos=function(){var a,b=this.$rootDiv[0],c=0,d=b.ownerDocument||b.document,e=d.defaultView||d.parentWindow;if("undefined"!=typeof e.getSelection){if(a=e.getSelection(),a.rangeCount>0){var f=e.getSelection().getRangeAt(0),g=f.cloneRange();g.selectNodeContents(b),g.setEnd(f.endContainer,f.endOffset),c=g.toString().length}}else if((a=d.selection)&&"Control"!=a.type){var h=a.createRange(),i=d.body.createTextRange();i.moveToElementText(b),i.setEndPoint("EndToEnd",h),c=i.text.length}return c},this.caretGetNode=function(){var a=document.getSelection().anchorNode;return null==a?$(null):$(3==a.nodeType?a.parentNode:a)},this.caretSetPos=function(a,b){if(!a||0==a.length)return console.warn("Midway Editor: caretSetPos() failed, invalid target node"),!1;var c=(this.$rootDiv,document.createRange()),d=window.getSelection();return c.setStart(a[0],b),c.collapse(!0),d.removeAllRanges(),d.addRange(c),!0},this.begin()},MidwayOptions={buttons:"bold italic link | h2 h3 blockquote"},Midway={edit:function(a,b){var c=$(a);if(b=$.extend(b,MidwayOptions),console.log(b),0==c.length)return console.error("Midway Editor: Could not find editable target:",a),null;var d=[];return c.each(function(){var a=$(this),c=new MidwayEditor(a,b);d.push(c),window.midwayInstance=c}),1==d.length?d[0]:(console.warn("Midway Editor: Found multiple targets with selector, making each editable:",a),d)}};